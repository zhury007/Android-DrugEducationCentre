var mysql = require("mysql");

function connectServer() {
  var client = mysql.createConnection({
    host: "localhost",
    user: "root",
    password: "123456",
    database: "drugeducationcentre"
  });

  return client;
}

//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
// sql语句

function doSelectUserSQL(client, UserID, callback) {
  client.query(
    'select Password,Number from tbl_student where Email="' + UserID + '"',
    function (err, results, fields) {
      if (err) throw err;

      callback(results);
    }
  );
}

function doInsertUserSQL(client, UserID, UserPassword, callback) {
  client.query(
    "insert into tbl_student(Email,Password) values(?,?)",
    [UserID, UserPassword],
    function (err, result) {
      if (err) {
        console.log("error:" + err.message);
        return err;
      }
      callback(err);
    }
  );
}

function doSelectQuestionnaireSQL(client, callback) {
  client.query(
    'select Id,Name,alarmscore from tbl_test_questionnaire',
    function (err, results, fields) {
      if (err) throw err;

      callback(results);
    }
  );
}

function doSelectQuestionSQL(client, QuestionnaireID, callback) {
  client.query(
    'select Number,Title,Answers,Scores from tbl_test_question where QuestionnaireId=' + QuestionnaireID,
    function (err, results, fields) {
      if (err) throw err;

      callback(results);
    }
  );
}

function doInsertTestresultSQL(client, StudentNum, QuestionnaireId, scores, Status, callback) {
  client.query(
    "insert into tbl_testresult(StudentNum,QuestionnaireId,Scores,Status) values(?,?,?,?)",
    [StudentNum, parseInt(QuestionnaireId), parseInt(scores), parseInt(Status)],
    function (err, result) {
      if (err) {
        console.log("error:" + err.message);
        return err;
      }
      callback(err);
    }
  );
}

// 修改密码
function doUpdatePersonalSQL(client, StudentNum, Password, callback) {
  client.query(
    "UPDATE tbl_student set Password=? where Number = ?",
    [Password, StudentNum],
    function (err, result) {
      if (err) {
        console.log("error:" + err.message);
        return err;
      }
      callback(err);
    }
  );
}

// 查询结果
function doSelectResultSQL(client, StudentNum, callback) {
  client.query(
    "SELECT Scores,Name,Status FROM tbl_testresult rst JOIN  tbl_test_questionnaire test WHERE rst.QuestionnaireId = test.Id ORDER BY rst.Id DESC LIMIT 1", [StudentNum],
    function (err, results, fields) {
      if (err) throw err;

      callback(results);
    }
  );
}

// end
//+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
exports.connect = connectServer;
exports.doSelectUserSQL = doSelectUserSQL;
exports.doInsertUserSQL = doInsertUserSQL;
exports.doSelectQuestionnaireSQL = doSelectQuestionnaireSQL;
exports.doSelectQuestionSQL = doSelectQuestionSQL;
exports.doInsertTestresultSQL = doInsertTestresultSQL;
exports.doUpdatePersonalSQL = doUpdatePersonalSQL;
exports.doSelectResultSQL = doSelectResultSQL;